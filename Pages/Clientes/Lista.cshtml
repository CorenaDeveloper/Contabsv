@page
@using System.Security.Claims
@model Contabsv_core.Pages.Clientes.ListaModel
@using Microsoft.AspNetCore.Antiforgery
@inject IAntiforgery Antiforgery
@inject IHttpContextAccessor HttpContextAccessor
@{
    var idCliente = User.FindFirst("IdCliente")?.Value ?? "0";
    var tokens = Antiforgery.GetAndStoreTokens(HttpContextAccessor.HttpContext);
}
  
<div class="card">
    <div class="card-header">
        <h5>Clientes</h5>
    </div>
    <div class="card-body">
        <div id="spinner" class="text-center">
            <div class="spinner-grow" style="width: 3rem; height: 3rem" role="status">
                <span class="sr-only">Loading...</span>
            </div>
        </div>

        <table id="tblClientes" class="display" style="width:100%; display: none;">
            <thead>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
</div>

<div id="eliminarClienteCltModal" class="modal fade" tabindex="-1" aria-labelledby="eliminarClienteCltModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form id="eliminarClienteCltForm" method="post" asp-page-handler="Delete">
                <div class="modal-header">
                    <h5 class="modal-title" id="eliminarClienteCltModalLabel">Confirmar Eliminación</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <p>¿Estás seguro de que deseas eliminar este ClienteClt?</p>
                    <input type="hidden" name="idClienteClt" id="idClienteCltInput" />
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger">Eliminar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    let table;

    $(document).ready(function () {
        if ($.fn.dataTable.isDataTable('#tblClientes')) {
            $('#tblClientes').DataTable().destroy();
        }

        table = new DataTable('#tblClientes', {
            responsive: true,
            processing: true,
            serverSide: false,
            ajax: {
                url: "/Clientes/Lista?handler=ClientesInt",
                type: "GET",
                dataType: "json",
                dataSrc: function (json) {
                    return json || [];
                },
                error: function (xhr, status, error) {
                    showAlert("danger", "Error al cargar clientes: " + error);
                }
            },
            columns: [
                {
                    data: null,
                    title: "NOMBRE",
                    render: function (data, type, row) {
                        if (row.personaJuridica) {
                            return row.nombreRazonSocial ?? '';
                        } else {
                            const nombres = row.nombres ?? '';
                            const apellidos = row.apellidos ?? '';
                            return `${nombres} ${apellidos}`.trim();
                        }
                    }
                },
                {
                    data: "personaJuridica",
                    title: "JURIDICA",
                    render: function (data) {
                        return (data = null ? '' : `<input type="checkbox" ${data ? "checked" : ""} disabled>`);
                    },
                    className: 'text-center'
                },
                { 
                    data: "nombreComercial", 
                    title: "NOMBRE COMERCIAL", 
                    render: (data) => data || '' 
                },
                { 
                    data: "duiCliente", 
                    title: "DUI CLIENTE", 
                    render: (data) => data || '' 
                },
                { 
                    data: "representanteLegal", 
                    title: "REPRESENTANTE LEGAL", 
                    render: (data) => data || '' 
                },
                { 
                    data: "duiRepresentanteLegal", 
                    title: "DUI REPRESENTANTE", 
                    render: (data) => data || '' 
                },
                { 
                    data: "celular", 
                    title: "CELULAR", 
                    render: (data) => data || '' 
                },
                { 
                    data: "telefonoCliente",
                    title: "TELÉFONO", 
                    render: (data) => data || ''
                },
                { 
                    data: "nrc", 
                    title: "NRC", 
                    render: (data) => data || ''
                },
                { 
                    data: "tipoContribuyente",
                    title: "TIPO CONTRIBUYENTE",
                    render: (data) => data || '' 
                },
                {
                    data: "nitCliente", 
                    title: "NIT", 
                    render: (data) => data || '' 
                },
                {
                    data: null,
                    title: "OPT",
                    orderable: false,
                    searchable: false,
                    render: function (data, type, row) {
                        return `
                                <button class="btn btn-sm btn-primary edit-btn" data-id="${row.idClienteClt}">
                                    <i class="fas fa-edit"></i> 
                                </button>
                                    <button class="btn btn-sm btn-danger delete-btn" data-id="${row.idClienteClt}">
                                    <i class="fas fa-trash"></i> 
                                </button>
                            `;
                    }
                }
            ],
            "initComplete": function (settings, json) {
                $("#spinner").hide();
                $("#tblClientes").show();

            },
            language: {
                search: "Buscar:",
                lengthMenu: "Mostrar _MENU_ registros por página",
                info: "Mostrando _START_ a _END_ de _TOTAL_ registros",
                infoEmpty: "No hay registros disponibles",
                infoFiltered: "(filtrado de _MAX_ registros totales)",
                loadingRecords: "Cargando...",
                zeroRecords: "No se encontraron resultados",
                emptyTable: "No hay datos disponibles en la tabla",
                paginate: {
                    first: "<span class='fas fa-angle-double-left'></span>",
                    last: "<span class='fas fa-angle-double-right'></span>",
                    next: "<span class='fas fa-chevron-right'></span>",
                    previous: "<span class='fas fa-chevron-left'></span>"
                }
            }
        });

        $('#tblClientes tbody').on('click', '.edit-btn', function () {
            let id = $(this).data('id');
            window.location.href = `Editar?id=${id}`;
        });


        $('#tblClientes tbody').on('click', '.delete-btn', function () {
            var id = $(this).data('id');
            $('#idClienteCltInput').val(id);
            $('#eliminarClienteCltModal').modal('show');
        });
    });
</script>
