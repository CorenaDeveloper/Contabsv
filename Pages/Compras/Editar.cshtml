@page
@model Contabsv_core.Pages.Compras.EditarModel
@using Contabsv_core.Models
@{
}
<div class="card">
    <div class="card-header" style="padding: 6px 10px;">
        <h6>EDITAR COMPRA</h6>
    </div>
    <div class="card-body">
        <form id="documentoForm" method="post" asp-page-handler="Mod">
            <input type="hidden" asp-for="Compra.idDocCompra" />
            <div class="row g-3">
                <div class="col-lg-3">
                    <label class="form-label">Fecha Emisión:</label>
                    <input type="date" class="form-control form-control-sm" id="fechaEmision" asp-for="Compra.fechaEmision">
                    <span asp-validation-for="Compra.fechaEmision" class="text-danger"></span>
                </div>

                <div class="col-lg-3">
                    <label class="form-label">Fecha Presentación:</label>
                    <input type="date" class="form-control form-control-sm" id="fechaPresentacion" asp-for="Compra.fechaPresentacion">
                    <span asp-validation-for="Compra.fechaPresentacion" class="text-danger"></span>
                </div>


                <div class="col-lg-3">
                    <label class="form-label">Clase Documento:</label>
                    <select id="idclaseDocumento" class="form-control form-select-sm" asp-for="Compra.idclaseDocumento">
                        @foreach (var item in ViewData["ClaseDocumentos"] as List<ClaseDocumentoModel>)
                        {
                            <option value="@item.id">@item.nombre</option>
                        }
                    </select>
                    <span asp-validation-for="Compra.idclaseDocumento" class="text-danger"></span>
                </div>

                <div class="col-lg-3">
                    <label class="form-label">Tipo Documento:</label>
                    <select class="form-select form-select-sm" id="idtipoDocumento" asp-for="Compra.idtipoDocumento">
                        @foreach (var item in ViewData["TipoDocumentos"] as List<TipoDocumentoModel>)
                        {
                            <option value="@item.id">@item.nombre</option>
                        }
                    </select>
                    <span asp-validation-for="Compra.idtipoDocumento" class="text-danger"></span>
                </div>

                <div class="col-lg-3">
                    <label class="form-label">Número Serie:</label>
                    <input type="text" class="form-control form-control-sm" id="numSerie" asp-for="Compra.numSerie">
                    <span asp-validation-for="Compra.numSerie" class="text-danger"></span>
                </div>

                <div class="col-lg-6">
                    <label class="form-label">Número Documento:</label>
                    <input type="text" class="form-control form-control-sm" id="numeroDocumento" asp-for="Compra.numeroDocumento">
                    <span asp-validation-for="Compra.numeroDocumento" class="text-danger"></span>
                </div>

                <div class="col-lg-3">
                    <label class="form-label">Combustible:</label>
                    <br />
                    <input type="checkbox" class="form-check-input" id="combustible" asp-for="Compra.combustible">
                    <span asp-validation-for="Compra.combustible" class="text-danger"></span>
                </div>

                <div class="col-lg-6">
                    <label class="form-label">Proveedor:</label>
                    <select id="idProveedor" class="form-control form-select-sm">
                        <option value="">Seleccione un proveedor</option>
                        @foreach (var item in ViewData["Proveedores"] as List<ProveedoresModel>)
                        {
                            <option value="@item.idProveedor"
                                    data-nit="@item.nitProveedor"
                                    data-nrc="@item.nrc"
                                    data-search="@($"{item.nombreRazonSocial} {item.nombres} {item.apellidos} {item.nitProveedor} {item.nrc}")"
                                    data-idsector="@item.idSector">
                                @(item.nombreRazonSocial ?? $"{item.nombres} {item.apellidos}")
                            </option>
                        }
                    </select>
                    <!-- Campo oculto para enviar idSector -->
                    <input type="hidden" id="idSector" asp-for="Compra.idSector">
                    <input type="hidden" id="idProveedorVal" asp-for="Compra.idProveedor">
                    <span asp-validation-for="Compra.idProveedor" class="text-danger"></span>
                </div>

                <div class="col-lg-6">
                    <input type="checkbox" id="mostrarCampos" class="form-check-input">
                    <label for="mostrarCampos" class="form-label    ">Mostrar datos para Internacionesles e Importaciones</label>
                </div>

                <hr class="my-3">
            </div>



            <div class="row">
                <div class="col-lg-3">
                    <label class="form-label">Internas Exentas:</label>
                    <input type="text" class="form-control form-control-sm" id="internasExentas" asp-for="Compra.internasExentas">
                    <span asp-validation-for="Compra.internasExentas" class="text-danger"></span>
                </div>
                <div class="col-lg-3">
                    <label class="form-label">Internas Gravadas:</label>
                    <input type="text" class="form-control form-control-sm" id="internasGravadas" asp-for="Compra.internasGravadas">
                    <span asp-validation-for="Compra.internasGravadas" class="text-danger"></span>
                </div>
                <div class="col-lg-3"></div>
                <div class="col-lg-3"></div>
            </div>


            <div class="row">
                <div class="col-lg-3 campos-ocultos">
                    <label class="form-label">Internaciones Gravadas Bienes:</label>
                    <input type="text" class="form-control form-control-sm" id="internacionesGravadasBienes" asp-for="Compra.internacionesGravadasBienes">
                    <span asp-validation-for="Compra.internacionesGravadasBienes" class="text-danger"></span>
                </div>
                <div class="col-lg-3 campos-ocultos">
                    <label class="form-label">Import. Y/NoSujetas:</label>
                    <input type="text" class="form-control form-control-sm" id="importacionesYONsujetas" asp-for="Compra.importacionesYONsujetas">
                    <span asp-validation-for="Compra.importacionesYONsujetas" class="text-danger"></span>
                </div>
                <div class="col-lg-3 campos-ocultos">
                    <label class="form-label">Import. Gravadas Bienes:</label>
                    <input type="text" class="form-control form-control-sm" id="importacionesGravadasBienes" asp-for="Compra.importacionesGravadasBienes">
                    <span asp-validation-for="Compra.importacionesGravadasBienes" class="text-danger"></span>
                </div>
                <div class="col-lg-3 campos-ocultos">
                    <label class="form-label">Import. Gravadas Servicios:</label>
                    <input type="text" class="form-control form-control-sm" id="importacionesGravadasServicios" asp-for="Compra.importacionesGravadasServicios">
                    <span asp-validation-for="Compra.importacionesGravadasServicios" class="text-danger"></span>
                </div>

            </div>

            <div class="row">
                <div class="col-lg-3 campos-ocultos">
                    <label class="form-label">Internac. Exentas/No Sujetas:</label>
                    <input type="text" class="form-control form-control-sm" id="internacionalesExentasYONsujetas" asp-for="Compra.internacionalesExentasYONsujetas">
                    <span asp-validation-for="Compra.internacionalesExentasYONsujetas" class="text-danger"></span>
                </div>
                <div class="col-lg-3">
                    <label class="form-label">Crédito Fiscal:</label>
                    <input type="text" class="form-control form-control-sm" id="creditoFiscal" disabled="disabled" asp-for="Compra.creditoFiscal">
                    <span asp-validation-for="Compra.creditoFiscal" class="text-danger"></span>
                </div>
                <div class="col-lg-3">
                    <label class="form-label">IVA Retenido:</label>
                    <input type="text" class="form-control form-control-sm" id="ivaRetenido" disabled="disabled" asp-for="Compra.ivaRetenido">
                    <span asp-validation-for="Compra.ivaRetenido" class="text-danger"></span>
                </div>
                <div class="col-lg-3">
                    <label class="form-label">Total Compras:</label>
                    <input type="text" class="form-control form-control-sm" id="totalCompras" disabled="disabled" asp-for="Compra.totalCompras">
                    <span asp-validation-for="Compra.totalCompras" class="text-danger"></span>
                </div>
            </div>

            <div class="row">
                <hr class="my-3">
                <div class="col-lg-3">
                    <label class="form-label">Tipo Operación:</label>
                    <select class="form-select form-select-sm" id="idTipoOperacion" asp-for="Compra.idTipoOperacion">
                        @foreach (var item in ViewData["Operaciones"] as List<OperacionesModel>)
                        {
                            <option value="@item.id">@item.descripcion</option>
                        }
                    </select>
                    <span asp-validation-for="Compra.idTipoOperacion" class="text-danger"></span>
                </div>

                <div class="col-lg-3">
                    <label class="form-label">Clasificación:</label>
                    <select class="form-select form-select-sm" id="idClasificacion" asp-for="Compra.idClasificacion">
                        @foreach (var item in ViewData["Clasificaciones"] as List<ClasificacionesModel>)
                        {
                            <option value="@item.id">@item.descripcion</option>
                        }
                    </select>
                    <span asp-validation-for="Compra.idClasificacion" class="text-danger"></span>
                </div>

                <div class="col-lg-3">
                    <label class="form-label">Tipo Costo/Gasto:</label>
                    <select class="form-select form-select-sm" id="idTipoCostoGasto" asp-for="Compra.idTipoCostoGasto">
                        @foreach (var item in ViewData["TipoOperacionIG"] as List<TipoOperacionIGModel>)
                        {
                            <option value="@item.id">@item.descripcion</option>
                        }
                    </select>
                    <span asp-validation-for="Compra.idTipoCostoGasto" class="text-danger"></span>
                </div>
                <div class="col-lg-3">
                    <label class="form-label">Total Doc:</label>
                    <input type="text" class="form-control form-control-sm" id="totalDocumento" disabled="disabled">
                </div>
            </div>

            <div class="mt-3 text-end">
                <button type="submit" class="btn btn-primary">Guardar</button>
            </div>
        </form>
    </div>
</div>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        let checkBox = document.getElementById("mostrarCampos");
        let campos = document.querySelectorAll(".campos-ocultos");

        checkBox.checked = false;
        campos.forEach(campo => campo.style.display = "none"); // Oculta completamente

        checkBox.addEventListener("change", function () {
            campos.forEach(campo => {
                campo.style.display = this.checked ? "block" : "none"; // Muestra u oculta
            });
        });
    });


    $(document).ready(function () {

        let campos = [
            "#internasExentas",
            "#internacionalesExentasYONsujetas",
            "#importacionesYONsujetas",
            "#internasGravadas",
            "#internacionesGravadasBienes",
            "#importacionesGravadasBienes",
            "#importacionesGravadasServicios"
        ];

        let totalDoc = [
            "#creditoFiscal",
            "#totalCompras"
        ];

        function actualizarTotales() {
            let totalCompras = 0;
            let creditoFiscal = 0;

            // Calcular Total Compras
            campos.forEach(function (campo) {
                totalCompras += parseFloat($(campo).val()) || 0;
            });
            $("#totalCompras").val(totalCompras.toFixed(2));

            // Calcular Crédito Fiscal
            let internasGravadas = parseFloat($("#internasGravadas").val()) || 0;
            let internacionesGravadasBienes = parseFloat($("#internacionesGravadasBienes").val()) || 0;
            let importacionesGravadasBienes = parseFloat($("#importacionesGravadasBienes").val()) || 0;
            let importacionesGravadasServicios = parseFloat($("#importacionesGravadasServicios").val()) || 0;

            creditoFiscal = (internasGravadas + internacionesGravadasBienes + importacionesGravadasBienes + importacionesGravadasServicios) * 0.13;
            $("#creditoFiscal").val(creditoFiscal.toFixed(2));

            // Calcular Total Documento
            let totalDocumento = totalCompras + creditoFiscal;
            $("#totalDocumento").val(totalDocumento.toFixed(2));
        }

        // Asignar eventos de input a los campos necesarios
        $(campos.join(", ") + ", #creditoFiscal").on("input", actualizarTotales);

        // Llamar a la función al cargar la página para inicializar los valores
        actualizarTotales();


        $("#idProveedor").select2({
            placeholder: "Seleccione un proveedor...",
            allowClear: true,
            theme: "bootstrap-5",
            templateResult: function (item) {
                if (!item.id) return item.text; // Evita error con el placeholder

                let nit = $(item.element).data("nit") || "N/A";
                let nrc = $(item.element).data("nrc") ? ` | NRC: ${$(item.element).data("nrc")}` : "";

                return $(`
                        <div>
                            <strong>${item.text}</strong><br>
                            <small>NIT: ${nit}${nrc}</small>
                        </div>
                    `);
            },
            templateSelection: function (item) {
                return item.text;
            },
            matcher: function (params, data) {
                if ($.trim(params.term) === '') {
                    return data;
                }

                // Buscar en nombre, NIT y NRC
                let searchText = $(data.element).data("search") || "";
                if (searchText.toLowerCase().includes(params.term.toLowerCase())) {
                    return data;
                }
                return null;
            }
        });

        // Cuando cambia el proveedor, actualiza el idSector oculto
        $("#idProveedor").on("change", function () {
            var idSector = $(this).find(":selected").data("idsector") || 0;
            var idProveedor = $(this).val() || 0;
            $("#idSector").val(idSector);
            $("#idProveedorVal").val(idProveedor);
        });

    });


</script>